<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"/>

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="keywords" content="yhzdys,杜恒">
<meta name="description" content="yhzdys,杜恒">
<meta name="theme-color" content="#222">
<title>yhzdys&#39;s·notes</title>
<link rel="shortcut icon" href="/favicon.ico?v=1656083350442">
<link rel="stylesheet" href="/media/css/pisces.css">
<link rel="stylesheet" href="/media/fonts/font-awesome.css">
<link href="//fonts.loli.net/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Rosario:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext"
      rel="stylesheet" type="text/css">

<link href="/media/hljs/styles/androidstudio.css"
      rel="stylesheet">

    <script src="https://cdn.staticfile.org/pace/1.0.2/pace.min.js"></script>
    <link href="https://cdn.staticfile.org/pace/1.2.4/themes/black/pace-theme-corner-indicator.css" rel="stylesheet"/>

<link rel="stylesheet" href="/styles/main.css">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="/media/js/jquery.js"></script>
<script src="/media/hljs/highlight.js"></script>
<script src="https://cdn.staticfile.org/velocity/1.5.2/velocity.min.js"></script>
<script src="https://cdn.staticfile.org/velocity/1.5.2/velocity.ui.min.js"></script>
<link rel="stylesheet" href="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.css"
      integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">


    <script defer src="https://cdn.staticfile.org/KaTeX/0.11.1/katex.min.js"
            integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz"
            crossorigin="anonymous"></script>
    <script defer src="https://cdn.staticfile.org/KaTeX/0.11.1/contrib/auto-render.min.js"
            integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
            onload="renderMathInElement(document.body);"></script>



    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XDVH3JN2B0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-XDVH3JN2B0');
    </script>


    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?e41c72c79749539f41bbd93bbc4c1a00";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    <meta name="description" content="yhzdys,杜恒">
</head>

<body>
<div class="head-top-line"></div>
<div class="header-box">
    
<div class="pisces">
    <header class="header  ">
        <div class="blog-header box-shadow-wrapper bg-color "
             id="header">
            <div class="nav-toggle" id="nav_toggle">
                <div class="toggle-box">
                    <div class="line line-top"></div>
                    <div class="line line-center"></div>
                    <div class="line line-bottom"></div>
                </div>
            </div>
            <div class="site-meta">
                <div class="site-title">
                    
                        <a href="/" class="brand">
                            <span>yhzdys&#39;s·notes</span>
                        </a>
                    
                </div>
                
                    <p class="subtitle"> </p>
                
            </div>
            <nav class="site-nav" id="site_nav">
                <ul id="nav_ul">
                    
                        
                        

                        <li class="nav-item ">
                            
                            
                                <a href="https://blog.yhzdys.com" target="_self">
                                    <i class="fa fa-home"></i> 首页
                                </a>
                            
                        </li>
                    
                        
                        

                        <li class="nav-item ">
                            
                            
                                <a href="https://blog.yhzdys.com/tags" target="_self">
                                    <i class="fa fa-tags"></i> 标签
                                </a>
                            
                        </li>
                    
                        
                        

                        <li class="nav-item ">
                            
                            
                                <a href="https://blog.yhzdys.com/archives" target="_self">
                                    <i class="fa fa-archive"></i> 归档
                                </a>
                            
                        </li>
                    
                        
                        

                        <li class="nav-item ">
                            
                            
                                <a href="https://blog.yhzdys.com/post/about" target="_self">
                                    <i class="fa fa-user"></i> 关于
                                </a>
                            
                        </li>
                    
                    
                    
                        <li id="fa_search" class="nav-item">
                            <a href="javascript:void(0);">
                                <i class="fa fa-search"></i> <span class="language" data-lan="search">搜索</span>
                            </a>
                        </li>
                    
                </ul>
            </nav>
        </div>
    </header>
</div>

<script type="text/javascript">

    let showNav = true;

    let navToggle = document.querySelector('#nav_toggle'),
        siteNav = document.querySelector('#site_nav');

    function navClick() {
        let sideBar = document.querySelector('.sidebar');
        let navUl = document.querySelector('#nav_ul');
        navToggle.classList.toggle('nav-toggle-active');
        siteNav.classList.toggle('nav-menu-active');
        if (siteNav.classList.contains('nav-menu-active')) {
            siteNav.style = "height: " + (navUl.children.length * 42) + "px !important";
        } else {
            siteNav.style = "";
        }
    }

    navToggle.addEventListener('click', navClick);
</script>
</div>
<div class="main-continer">
    
    <div
            class="section-layout  pisces">
        <div class="section-layout-wrapper">
            <div id="sidebarMeta" class="sidebar">
    
<div class="sidebar-wrapper box-shadow-wrapper bg-color">
    <div class="sidebar-item">
        <img class="site-author-image right-motion" src="/images/avatar.png"/>
        <p class="site-author-name">yhzdys</p>
        
    </div>
    <div class="sidebar-item side-item-stat right-motion">
        <div class="sidebar-item-box">
            <a href="/archives/">
                
                <span class="site-item-stat-count">4</span>
                <span class="site-item-stat-name language" data-lan="article">文章</span>
            </a>
        </div>
        <div class="sidebar-item-box">
            <a href="/tags/">
                <span class="site-item-stat-count">3</span>
                <span class="site-item-stat-name language" data-lan="tag">标签</span>
            </a>
        </div>
    </div>
    
        
    
    
    
        
    
    
    
</div>
</div>
<script>
    let sidebarMeta = document.querySelector('#sidebarMeta');
    let scheme = 'pisces';
    let sidebarWrapper = document.querySelector('.sidebar-wrapper');
    if (sidebarMeta && (scheme === 'pisces' || scheme === 'gemini')) {
        document.addEventListener('scroll', function () {
            if (document.scrollingElement.scrollTop > parseInt(sidebarMeta.style.marginTop) + 10) {
                sidebarWrapper.classList.add('home-sidebar-fixed')
            } else {
                sidebarWrapper.classList.remove('home-sidebar-fixed')
            }
        });
    }
</script>
            <div class="section-box box-shadow-wrapper">
                <section class="section archives-section bg-color posts-expand">
                    

<div class="bg-color">
    <div class="archive-timeline-box">
        <div class="archive-timeline-title">
            
                <h2 class="language" data-lan="archives" data-count="4">目前共计4篇文章</h2>
            
        </div>
        
            
            
                <div class="node-title">
                    <h2 class="tag-year">2022</h2>
                </div>
                
            
            <a href="https://blog.yhzdys.com/post/220508133607/">
                <div class="motion-warpper tag-archive-node">
                    <div class="tag-node">
                        <h1>
                            05-08
                            <small>加权随机算法</small>
                        </h1>
                    </div>
                </div>
            </a>
        
            
            
            <a href="https://blog.yhzdys.com/post/220304224140/">
                <div class="motion-warpper tag-archive-node">
                    <div class="tag-node">
                        <h1>
                            03-04
                            <small>加权轮询算法</small>
                        </h1>
                    </div>
                </div>
            </a>
        
            
            
                <div class="node-title">
                    <h2 class="tag-year">2021</h2>
                </div>
                
            
            <a href="https://blog.yhzdys.com/post/211027212445/">
                <div class="motion-warpper tag-archive-node">
                    <div class="tag-node">
                        <h1>
                            10-27
                            <small>Dubbo SPI</small>
                        </h1>
                    </div>
                </div>
            </a>
        
            
            
                <div class="node-title">
                    <h2 class="tag-year">2019</h2>
                </div>
                
            
            <a href="https://blog.yhzdys.com/post/191003205847/">
                <div class="motion-warpper tag-archive-node">
                    <div class="tag-node">
                        <h1>
                            10-03
                            <small>滑动时间窗算法</small>
                        </h1>
                    </div>
                </div>
            </a>
        
    </div>
    
<div class="page bg-color">
    <ul class="pagination-ul">
        
        
            
                <li class="pagination-li pagination-active">
                    <a href="/archives/page/../">
                        1
                    </a>
                </li>
            
        
        
    </ul>
</div>
</div>

                </section>
            </div>
        </div>
    </div>
    <div class="footer-box">
    <footer class="footer">
        <center id="runTimeBox">
            已运行:<span id="run_time"></span>
        </center>
        <span id="busuanzi_container_site_pv">浏览数:<span id="busuanzi_value_site_pv"></span> 次</span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">访客数:<span id="busuanzi_value_site_uv"></span> 人</span>

        <script>
            BirthDay = new Date('2017-07-18 20:46:38');
            if (BirthDay.getTime()) {
                function runTime() {
                    str = "";
                    today = new Date();
                    timeold = today.getTime() - BirthDay.getTime();
                    msPerDay = 24 * 60 * 60 * 1000;
                    e_daysold = timeold / msPerDay;
                    daysold = Math.floor(e_daysold);
                    str += daysold + "天";
                    return str;
                }

                setInterval(function () {
                    $("#run_time").html(runTime());
                }, 1000);
            } else {
                document.querySelector('.footer').removeChild(document.querySelector('#runTimeBox'));
            }
        </script>
        <div class="footerInfo">
            
        </div>
    </footer>
    
    
    <div class="pisces back-to-top" id="back_to_top">
        <i class="fa fa-arrow-up"></i>
        
            <span class="scrollpercent"> <span id="back_to_top_text">0</span>% </span>
        
    </div>
    
    
        
<link rel="stylesheet" href="/media/live2d/css/live2d.css"/>
<div class="box-scale">
    <div id="landlord" style="left: 5px;bottom: -20px;"
         data-key="2f2f55582c6944118a25abc6ef5e723c">
        <canvas id="live2d" width="500" height="560" class="live2d"></canvas>
        
            <div class="message" style="opacity:0"></div>
            <div class="live_talk_input_body">
                <div class="live_talk_input_name_body">
                    <input name="name" type="text" class="live_talk_name white_input" id="AIuserName" autocomplete="off"
                           placeholder="你的名字"/>
                </div>
                <div class="live_talk_input_text_body">
                    <input name="talk" type="text" class="live_talk_talk white_input" id="AIuserText" autocomplete="off"
                           placeholder="要和我聊什么呀？"/>
                    <button type="button" class="live_talk_send_btn" id="talk_send">发送</button>
                </div>
            </div>
            <input name="live_talk" id="live_talk" value="1" type="hidden"/>
            <div class="live_ico_box">
                <div class="live_ico_item type_info" id="showInfoBtn"></div>
                <div class="live_ico_item type_talk" id="showTalkBtn"></div>
                
                    <div class="live_ico_item type_music" id="musicButton"></div>
                
                <div class="live_ico_item type_quit" id="hideButton"></div>
                <input name="live_statu_val" id="live_statu_val" value="0" type="hidden"/>
                <audio src="" style="display:none;" id="live2d_bgm" data-bgm="0" preload="none"></audio>
                <input id="duType" value="douqilai" type="hidden">
                
                    <input name="live2dBGM" value="http://link.jscdn.cn/1drv/aHR0cHM6Ly8xZHJ2Lm1zL3UvcyFBa3NzTDBNMGNJNzdnUWFPSFdyRTBSaGFYOUg4P2U9YkxPdEY4.flac" type="hidden">
                
            </div>
        
    </div>
</div>
<div id="open_live2d">刻刻帝 !!!</div>
<script>
    var message_Path = 'https://live2d.yhzdys.com/';
    let landlord = document.querySelector('#landlord');
    var apiKey = landlord.dataset.key;
</script>
<script type="text/javascript" src="/media/live2d/js/live2d.js"></script>
<script>
    var homePath = document.location.protocol + '//' + window.document.location.hostname + ":" + window.document.location.port + '/';
    var userAgent = window.navigator.userAgent.toLowerCase();
    var norunAI = ["android", "iphone", "ipod", "ipad", "windows phone", "mqqbrowser", "msie", "trident/7.0"];
    var norunFlag = false;

    for (var i = 0; i < norunAI.length; i++) {
        if (userAgent.indexOf(norunAI[i]) > -1) {
            norunFlag = true;
            break;
        }
    }

    if (!window.WebGLRenderingContext) {
        norunFlag = true;
    }

    if (!norunFlag) {
        var hitFlag = false;
        var AIFadeFlag = false;
        var liveTlakTimer = null;
        var sleepTimer_ = null;
        var AITalkFlag = false;
        var talkNum = 0;
        (function () {
            function renderTip(template, context) {
                var tokenReg = /(\\)?\{([^\{\}\\]+)(\\)?\}/g;
                return template.replace(tokenReg, function (word, slash1, token, slash2) {
                    if (slash1 || slash2) {
                        return word.replace('\\', '');
                    }
                    var variables = token.replace(/\s/g, '').split('.');
                    var currentObject = context;
                    var i, length, variable;
                    for (i = 0, length = variables.length; i < length; ++i) {
                        variable = variables[i];
                        currentObject = currentObject[variable];
                        if (currentObject === undefined || currentObject === null) return '';
                    }
                    return currentObject;
                });
            }

            String.prototype.renderTip = function (context) {
                return renderTip(this, context);
            };

            var re = /x/;
            re.toString = function () {
                showMessage('哈哈，你打开了控制台，是想要看看我的秘密吗？', 5000);
                return '';
            };

            $(document).on('copy', function () {
                showMessage('你都复制了些什么呀，转载要记得加上出处哦~~', 5000);
            });

            function initTips() {
                $.ajax({
                    cache: true,
                    url: message_Path + 'message.json',
                    dataType: "json",
                    success: function (result) {
                        $.each(result.mouseover, function (index, tips) {
                            $(tips.selector).mouseover(function () {
                                var text = tips.text;
                                if (Array.isArray(tips.text)) text = tips.text[Math.floor(Math.random() * tips.text.length + 1) - 1];
                                text = text.renderTip({text: $(this).text()});
                                showMessage(text, 3000);
                                talkValTimer();
                                clearInterval(liveTlakTimer);
                                liveTlakTimer = null;
                            });
                            $(tips.selector).mouseout(function () {
                                showHitokoto();
                                if (liveTlakTimer == null) {
                                    liveTlakTimer = window.setInterval(function () {
                                        showHitokoto();
                                    }, 15000);
                                }
                            });
                        });
                        $.each(result.click, function (index, tips) {
                            $(tips.selector).click(function () {
                                if (hitFlag) {
                                    return false
                                }
                                hitFlag = true;
                                setTimeout(function () {
                                    hitFlag = false;
                                }, 8000);
                                var text = tips.text;
                                if (Array.isArray(tips.text)) text = tips.text[Math.floor(Math.random() * tips.text.length + 1) - 1];
                                text = text.renderTip({text: $(this).text()});
                                showMessage(text, 3000);
                            });
                            clearInterval(liveTlakTimer);
                            liveTlakTimer = null;
                            liveTlakTimer = window.setInterval(function () {
                                showHitokoto();
                            }, 15000);
                        });
                    }
                });
            }

            initTips();

            var text;
            if (document.referrer !== '') {
                var referrer = document.createElement('a');
                referrer.href = document.referrer;
                text = '嗨！来自 <span style="color:#0099cc;">' + referrer.hostname + '</span> 的朋友！';
                var domain = referrer.hostname.split('.')[1];
                if (domain == 'baidu') {
                    text = '嗨！ 来自 百度搜索 的朋友！<br>欢迎访问<span style="color:#0099cc;">「 ' + document.title.split(' - ')[0] + ' 」</span>';
                } else if (domain == 'bing') {
                    text = '嗨！ 来自 必应搜索 的朋友！<br>欢迎访问<span style="color:#0099cc;">「 ' + document.title.split(' - ')[0] + ' 」</span>';
                } else if (domain == 'so') {
                    text = '嗨！ 来自 360搜索 的朋友！<br>欢迎访问<span style="color:#0099cc;">「 ' + document.title.split(' - ')[0] + ' 」</span>';
                } else if (domain == 'google') {
                    text = '嗨！ 来自 谷歌搜索 的朋友！<br>欢迎访问<span style="color:#0099cc;">「 ' + document.title.split(' - ')[0] + ' 」</span>';
                }
            } else {
                // 主页URL判断，需要斜杠结尾
                if (window.location.href == homePath) {
                    var now = (new Date()).getHours();
                    if (now > 23 || now <= 5) {
                        text = '你是夜猫子呀？这么晚还不睡觉，明天起的来嘛？';
                    } else if (now > 5 && now <= 7) {
                        text = '早上好！一日之计在于晨，美好的一天就要开始了！';
                    } else if (now > 7 && now <= 11) {
                        text = '上午好！工作顺利嘛，不要久坐，多起来走动走动哦！';
                    } else if (now > 11 && now <= 14) {
                        text = '中午了，工作了一个上午，现在是午餐时间！';
                    } else if (now > 14 && now <= 17) {
                        text = '午后很容易犯困呢，今天的运动目标完成了吗？';
                    } else if (now > 17 && now <= 19) {
                        text = '傍晚了！窗外夕阳的景色很美丽呢，最美不过夕阳红~~';
                    } else if (now > 19 && now <= 21) {
                        text = '晚上好，今天过得怎么样？';
                    } else if (now > 21 && now <= 23) {
                        text = '已经这么晚了呀，早点休息吧，晚安~~';
                    } else {
                        text = '嗨~ 快来逗我玩吧！';
                    }
                } else {
                    text = '欢迎阅读<span style="color:#0099cc;">「 ' + document.title.split(' - ')[0] + ' 」</span>';
                }
            }
            showMessage(text, 12000);
        })();

        liveTlakTimer = setInterval(function () {
            showHitokoto();
        }, 15000);

        function showHitokoto() {
            if (sessionStorage.getItem("Sleepy") !== "1") {
                if (!AITalkFlag) {
                    $.getJSON('https://v1.hitokoto.cn/?c=a', function (result) {
                        talkValTimer();
                        showMessage(result.hitokoto, 0);
                    });
                }
            } else {
                hideMessage(0);
                if (sleepTimer_ == null) {
                    sleepTimer_ = setInterval(function () {
                        checkSleep();
                    }, 200);
                }
            }
        }

        function checkSleep() {
            var sleepStatu = sessionStorage.getItem("Sleepy");
            if (sleepStatu !== '1') {
                talkValTimer();
                showMessage('你回来啦~', 0);
                clearInterval(sleepTimer_);
                sleepTimer_ = null;
            }
        }

        function showMessage(text, timeout) {
            if (Array.isArray(text)) text = text[Math.floor(Math.random() * text.length + 1) - 1];
            $('.message').stop();
            $('.message').html(text);
            $('.message').fadeTo(200, 1);
            // if (timeout === null) timeout = 5000;
            // hideMessage(timeout);
        }

        function talkValTimer() {
            $('#live_talk').val('1');
        }

        function hideMessage(timeout) {
            // $('.message').stop().css('opacity',1);
            if (timeout === null) timeout = 5000;
            $('.message').delay(timeout).fadeTo(200, 0);
        }

        function initLive2d() {
            $('#hideButton').on('click', function () {
                if (AIFadeFlag) {
                    return false;
                } else {
                    AIFadeFlag = true;
                    localStorage.setItem("live2dhidden", "0");
                    $('#landlord').fadeOut(200);
                    $('#open_live2d').delay(200).fadeIn(200);
                    setTimeout(function () {
                        AIFadeFlag = false;
                    }, 300);
                }
            });
            $('#open_live2d').on('click', function () {
                if (AIFadeFlag) {
                    return false;
                } else {
                    AIFadeFlag = true;
                    localStorage.setItem("live2dhidden", "1");
                    $('#open_live2d').fadeOut(200);
                    $('#landlord').delay(200).fadeIn(200);
                    setTimeout(function () {
                        AIFadeFlag = false;
                    }, 300);
                }
            });
            if (apiKey) {
                $('#showInfoBtn').on('click', function () {
                    var live_statu = $('#live_statu_val').val();
                    if (live_statu == "0") {
                        return
                    } else {
                        $('#live_statu_val').val("0");
                        $('.live_talk_input_body').fadeOut(500);
                        AITalkFlag = false;
                        showHitokoto();
                        $('#showTalkBtn').show();
                        $('#showInfoBtn').hide();
                    }
                });
                $('#showTalkBtn').on('click', function () {
                    var live_statu = $('#live_statu_val').val();
                    if (live_statu == "1") {
                        return
                    } else {
                        $('#live_statu_val').val("1");
                        $('.live_talk_input_body').fadeIn(500);
                        AITalkFlag = true;
                        $('#showTalkBtn').hide();
                        $('#showInfoBtn').show();

                    }
                });
                $('#talk_send').on('click', function () {
                    var info_ = $('#AIuserText').val();
                    var userid_ = $('#AIuserName').val();
                    if (info_ == "") {
                        showMessage('写点什么吧！', 0);
                        return;
                    }
                    if (userid_ == "") {
                        showMessage('聊之前请告诉我你的名字吧！', 0);
                        return;
                    }
                    showMessage('思考中~', 0);
                    let protocol = window.location.protocol.indexOf("s") > 0 ? "https" : "http";
                    $.ajax({
                        type: "get",
                        url: `${protocol}://www.tuling123.com/openapi/api?key=${apiKey}&info=${info_}`,
                        dataType: "json",
                        success: function (res) {
                            talkValTimer();
                            showMessage(res.text, 0);
                            $('#AIuserText').val("");
                            sessionStorage.setItem("live2duser", userid_);
                        },
                        error: function (e) {
                            talkValTimer();
                            showMessage('似乎有什么错误，请和站长联系！', 0);
                        }
                    });
                });
            } else {
                $('#showInfoBtn').hide();
                $('#showTalkBtn').hide();
            }
            // 获取音乐信息初始化
            var bgmListInfo = $('input[name=live2dBGM]');
            if (bgmListInfo.length == 0) {
                $('#musicButton').hide();
            } else {
                var bgmPlayNow = parseInt($('#live2d_bgm').attr('data-bgm'));
                var bgmPlayTime = 0;
                var live2dBGM_Num = sessionStorage.getItem("live2dBGM_Num");
                var live2dBGM_PlayTime = sessionStorage.getItem("live2dBGM_PlayTime");
                if (live2dBGM_Num) {
                    if (live2dBGM_Num <= $('input[name=live2dBGM]').length - 1) {
                        bgmPlayNow = parseInt(live2dBGM_Num);
                    }
                }
                if (live2dBGM_PlayTime) {
                    bgmPlayTime = parseInt(live2dBGM_PlayTime);
                }
                var live2dBGMSrc = bgmListInfo.eq(bgmPlayNow).val();
                $('#live2d_bgm').attr('data-bgm', bgmPlayNow);
                $('#live2d_bgm').attr('src', live2dBGMSrc);
                $('#live2d_bgm')[0].currentTime = bgmPlayTime;
                $('#live2d_bgm')[0].volume = 0.5;
                var live2dBGM_IsPlay = sessionStorage.getItem("live2dBGM_IsPlay");
                var live2dBGM_WindowClose = sessionStorage.getItem("live2dBGM_WindowClose");
                if (live2dBGM_IsPlay == '0' && live2dBGM_WindowClose == '0') {
                    $('#live2d_bgm')[0].play();
                    $('#musicButton').addClass('play');
                }
                sessionStorage.setItem("live2dBGM_WindowClose", '1');
                $('#musicButton').on('click', function () {
                    if ($('#musicButton').hasClass('play')) {
                        $('#live2d_bgm')[0].pause();
                        $('#musicButton').removeClass('play');
                        sessionStorage.setItem("live2dBGM_IsPlay", '1');
                    } else {
                        $('#live2d_bgm')[0].play();
                        $('#musicButton').addClass('play');
                        sessionStorage.setItem("live2dBGM_IsPlay", '0');
                    }
                });
                window.onbeforeunload = function () {
                    sessionStorage.setItem("live2dBGM_WindowClose", '0');
                    if ($('#musicButton').hasClass('play')) {
                        sessionStorage.setItem("live2dBGM_IsPlay", '0');
                    }
                }
                document.getElementById('live2d_bgm').addEventListener("timeupdate", function () {
                    var live2dBgmPlayTimeNow = document.getElementById('live2d_bgm').currentTime;
                    sessionStorage.setItem("live2dBGM_PlayTime", live2dBgmPlayTimeNow);
                });
                document.getElementById('live2d_bgm').addEventListener("ended", function () {
                    var listNow = parseInt($('#live2d_bgm').attr('data-bgm'));
                    listNow++;
                    if (listNow > $('input[name=live2dBGM]').length - 1) {
                        listNow = 0;
                    }
                    var listNewSrc = $('input[name=live2dBGM]').eq(listNow).val();
                    sessionStorage.setItem("live2dBGM_Num", listNow);
                    $('#live2d_bgm').attr('src', listNewSrc);
                    $('#live2d_bgm')[0].play();
                    $('#live2d_bgm').attr('data-bgm', listNow);
                });
                document.getElementById('live2d_bgm').addEventListener("error", function () {
                    $('#live2d_bgm')[0].pause();
                    $('#musicButton').removeClass('play');
                    showMessage('音乐似乎加载不出来了呢！', 0);
                });
            }
            // 获取用户名
            var live2dUser = sessionStorage.getItem("live2duser");
            if (live2dUser !== null) {
                $('#AIuserName').val(live2dUser);
            }
            // 获取位置
            var landL = sessionStorage.getItem("historywidth");
            var landB = sessionStorage.getItem("historyheight");
            if (landL == null || landB == null) {
                landL = '5px'
                landB = '0px'
            }
            $('#landlord').css('left', landL + 'px');
            $('#landlord').css('bottom', landB + 'px');

            // 移动
            function getEvent() {
                return window.event || arguments.callee.caller.arguments[0];
            }

            var smcc = document.getElementById("landlord");
            var moveX = 0;
            var moveY = 0;
            var moveBottom = 0;
            var moveLeft = 0;
            var moveable = false;
            var docMouseMoveEvent = document.onmousemove;
            var docMouseUpEvent = document.onmouseup;
            smcc.onmousedown = function () {
                var ent = getEvent();
                moveable = true;
                moveX = ent.clientX;
                moveY = ent.clientY;
                var obj = smcc;
                moveBottom = parseInt(obj.style.bottom);
                moveLeft = parseInt(obj.style.left);
                if (isFirefox = navigator.userAgent.indexOf("Firefox") > 0) {
                    window.getSelection().removeAllRanges();
                }
                document.onmousemove = function () {
                    if (moveable) {
                        var ent = getEvent();
                        var x = moveLeft + ent.clientX - moveX;
                        var y = moveBottom + (moveY - ent.clientY);
                        obj.style.left = x + "px";
                        obj.style.bottom = y + "px";
                    }
                };
                document.onmouseup = function () {
                    if (moveable) {
                        var historywidth = obj.style.left;
                        var historyheight = obj.style.bottom;
                        historywidth = historywidth.replace('px', '');
                        historyheight = historyheight.replace('px', '');
                        sessionStorage.setItem("historywidth", historywidth);
                        sessionStorage.setItem("historyheight", historyheight);
                        document.onmousemove = docMouseMoveEvent;
                        document.onmouseup = docMouseUpEvent;
                        moveable = false;
                        moveX = 0;
                        moveY = 0;
                        moveBottom = 0;
                        moveLeft = 0;
                    }
                };
            };
        }

        $(document).ready(function () {
            var AIimgSrc = [];
            let chooseLive2d = 'kurumi'
            if (chooseLive2d === 'kurumi') {
                AIimgSrc.push(message_Path + "models/kurumi/textures/t1.png");
                AIimgSrc.push(message_Path + "models/kurumi/textures/t2.png");
                AIimgSrc.push(message_Path + "models/kurumi/textures/t3.png");
            }
            var images = [];
            var imgLength = AIimgSrc.length;
            var loadingNum = 0;
            for (var i = 0; i < imgLength; i++) {
                images[i] = new Image();
                images[i].src = AIimgSrc[i];
                images[i].onload = function () {
                    loadingNum++;
                    if (loadingNum === imgLength) {
                        var live2dhidden = localStorage.getItem("live2dhidden");
                        if (live2dhidden === "0") {
                            setTimeout(function () {
                                $('#open_live2d').fadeIn(200);
                            }, 1300);
                        } else {
                            setTimeout(function () {
                                $('#landlord').fadeIn(200);
                            }, 1300);
                        }
                        let model = '';
                        if (chooseLive2d === 'kurumi') {
                            model = message_Path + "models/kurumi/model.json";
                        }
                        setTimeout(function () {
                            loadlive2d("live2d", model);
                        }, 1000);
                        initLive2d();
                        images = null;
                    }
                }
            }
        });
    }
</script>
    
    
</div>
<script>
    let sideBarOpen = "sidebar-open";
    let body = document.body;
    let back2Top = document.querySelector("#back_to_top"),
        back2TopText = document.querySelector("#back_to_top_text"),
        drawerBox = document.querySelector("#drawer_box"),
        rightSideBar = document.querySelector(".sidebar"),
        viewport = document.querySelector("body");

    function scrollAnimation(currentY, targetY) {
        let needScrollTop = targetY - currentY;
        let _currentY = currentY;
        setTimeout(() => {
            const dist = Math.ceil(needScrollTop / 10);
            _currentY += dist;
            window.scrollTo(_currentY, currentY);
            if (needScrollTop > 10 || needScrollTop < -10) {
                scrollAnimation(_currentY, targetY);
            } else {
                window.scrollTo(_currentY, targetY);
            }
        }, 1);
    }

    back2Top.addEventListener("click", function (e) {
        scrollAnimation(document.scrollingElement.scrollTop, 0);
        e.stopPropagation();
        return false;
    });

    window.addEventListener("scroll", function (e) {
        let percent =
            (document.scrollingElement.scrollTop /
                (document.scrollingElement.scrollHeight -
                    document.scrollingElement.clientHeight)) *
            100;
        if (percent > 1 && !back2Top.classList.contains("back-top-active")) {
            back2Top.classList.add("back-top-active");
        }
        if (percent == 0) {
            back2Top.classList.remove("back-top-active");
        }
        if (back2TopText) {
            back2TopText.textContent = Math.floor(percent);
        }
    });

    let hasCacu = false;
    window.addEventListener("resize", function (e) {
        calcHeight();
    });

    function calcHeight() {
        // 动态调整站点概览高度
        if ((!hasCacu && back2Top.classList.contains("pisces")) || back2Top.classList.contains("gemini")) {
            let sideBar = document.querySelector(".sidebar");
            let navUl = document.querySelector("#site_nav");
            sideBar.style = "margin-top:" + (navUl.offsetHeight + navUl.offsetTop + 15) + "px;";
            hasCacu = true;
        }
    }
    calcHeight();
    let open = false,
        MOTION_TIME = 300,
        RIGHT_MOVE_DIS = "320px";

    if (drawerBox) {
        let rightMotions = document.querySelectorAll(".right-motion");
        let right = drawerBox.classList.contains("right");
        let transitionDir = right ? "transition.slideRightIn" : "transition.slideLeftIn";
        let openProp, closeProp;
        if (right) {
            openProp = {
                paddingRight: RIGHT_MOVE_DIS,
            };
            closeProp = {
                paddingRight: "0px",
            };
        } else {
            openProp = {
                paddingLeft: RIGHT_MOVE_DIS,
            };
            closeProp = {
                paddingLeft: "0px",
            };
        }

        drawerBox.onclick = function () {
            open = !open;
            jQuery.Velocity(rightSideBar, "stop");
            jQuery.Velocity(viewport, "stop");
            jQuery.Velocity(rightMotions, "stop");
            if (open) {
                jQuery.Velocity(
                    rightSideBar,
                    {
                        width: RIGHT_MOVE_DIS,
                    },
                    {
                        duration: MOTION_TIME,
                        begin: function () {
                            jQuery.Velocity(rightMotions, transitionDir, {});
                        },
                    }
                );
                jQuery.Velocity(viewport, openProp, {
                    duration: MOTION_TIME,
                });
            } else {
                jQuery.Velocity(
                    rightSideBar,
                    {
                        width: "0px",
                    },
                    {
                        duration: MOTION_TIME,
                        begin: function () {
                            jQuery.Velocity(rightMotions, {
                                opacity: 0,
                            });
                        },
                    }
                );
                jQuery.Velocity(viewport, closeProp, {
                    duration: MOTION_TIME,
                });
            }
            for (let i = 0; i < drawerBox.children.length; i++) {
                drawerBox.children[i].classList.toggle("muse-line");
            }
            drawerBox.classList.toggle(sideBarOpen);
        };
    }

    // 链接跳转
    let newWindow = "false";
    if (newWindow === "true") {
        let links = document.querySelectorAll(".post-body a");
        links.forEach((item) => {
            if (!item.classList.contains("btn")) {
                item.setAttribute("target", "_blank");
            }
        });
    }

    let faSearch = document.querySelector("#fa_search");
    faSearch &&
    faSearch.addEventListener("click", function () {
        document.querySelector("#search_mask").style = "";
    });

    // 代码高亮
    hljs.highlightAll();

    // 离开当前页title变化
    var leaveTitle = "_(ˇωˇ」∠)_";
    var normal_title = document.title;
    if (leaveTitle) {
        document.addEventListener("visibilitychange", function () {
            if (document.visibilityState == "hidden") {
                normal_title = document.title;
                document.title = leaveTitle;
            } else {
                document.title = normal_title;
            }
        });
    }
</script>

<link rel="stylesheet" href="/media/css/jquery.fancybox.css"/>
<script src="/media/js/jquery.fancybox.js"></script>

<script>
    let images = document.querySelectorAll(".section img");
    images.forEach((image) => {
        var parent = image.parentElement;
        var next = image.nextElementSibling;
        parent.removeChild(image);
        var aelem = document.createElement("a");
        aelem.href = image.src;
        aelem.dataset["fancybox"] = "images";
        aelem.dataset["rel"] = "fancybox-button";
        aelem.classList.add("fancybox");
        aelem.appendChild(image);
        parent.insertBefore(aelem, next);
    });
</script>
</div>
</body>

    <div class="search-mask" id="search_mask" style="display: none;">
    <div class="search-box">
        <div class="search-title">
            <i class="fa fa-search"></i>
            <div class="input-box">
                <input id="search" type="text" class="language" data-lan="search" placeholder="搜索">
            </div>
            <i id="close" class="fa fa-times-circle"></i>
        </div>
        <div class="stat-box">
            <span id="stat_count">0</span>
            <span class="language" data-lan="stat">条相关条目，使用了</span>
            <span id="stat_times">0</span>
            <span class="language" data-lan="stat-time">毫秒</span>
            <hr>
        </div>
        <div class="result" id="result">
            
                <div class="item">
                    <a class="result-title" style="opacity: 0;" href="https://blog.yhzdys.com/post/220508133607/"" data-c="
                    &lt;blockquote&gt;
&lt;p&gt;给上一篇博文填个坑，讲解下负载均衡算法中最常见的加权随机算法&lt;/p&gt;
&lt;/blockquote&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;加权随机算法&#34;&gt;加权随机算法&lt;/h2&gt;
&lt;p&gt;负载均衡的一种算法实现，效果是按服务的权重设置，非顺序地请求资源服务。&lt;/p&gt;
&lt;h2 id=&#34;源码分析&#34;&gt;源码分析&lt;/h2&gt;
&lt;p&gt;Dubbo的负载均衡算法实现，放在org.apache.dubbo.rpc.cluster包下，以org.apache.dubbo.rpc.cluster.LoadBalance定义，通过SPI功能动态加载，默认实现为org.apache.dubbo.rpc.cluster.loadbalance.RandomLoadBalance（加权随机）&lt;/p&gt;
&lt;h3 id=&#34;源码实现&#34;&gt;源码实现&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;protected &amp;lt;T&amp;gt; Invoker&amp;lt;T&amp;gt; doSelect(List&amp;lt;Invoker&amp;lt;T&amp;gt;&amp;gt; invokers, URL url, Invocation invocation) {
        int length = invokers.size();
        // 标记位，标识所有服务的权重是否全都相同
        boolean sameWeight = true;
        // 每个服务下标对应的权重，在x轴坐标上的位置
        // 例：ABC三个服务的权重为10、20、30，为所有服务创建一个一维坐标，则A服务落在距离原点为10的位置，B落在距离原点30的位置，C落在距离原点60的位置
        int[] weights = new int[length];
        // 所有服务静态权重之和
        int totalWeight = 0;
        for (int i = 0; i &amp;lt; length; i++) {
            int weight = getWeight(invokers.get(i), invocation);
            totalWeight += weight;
            // 服务距离坐标系原点的位置
            weights[i] = totalWeight;
            if (sameWeight &amp;amp;&amp;amp; totalWeight != weight * (i + 1)) {
                sameWeight = false;
            }
        }
        // 当所有服务的权重不全相等时，触发加权随机
        if (totalWeight &amp;gt; 0 &amp;amp;&amp;amp; !sameWeight) {
            // 以0到所有服务权重之和为区间取随机数
            int offset = ThreadLocalRandom.current().nextInt(totalWeight);
            // 将随机数放在上述建立的一位坐标中，取在随机数落点右边且最近的一台服务作为选举结果
            for (int i = 0; i &amp;lt; length; i++) {
                if (offset &amp;lt; weights[i]) {
                    return invokers.get(i);
                }
            }
        }
        // 当所有服务的权重全都相等时，完全随机调用
        return invokers.get(ThreadLocalRandom.current().nextInt(length));
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;源码分析-2&#34;&gt;源码分析&lt;/h3&gt;
&lt;p&gt;首先Dubbo会轮训所调用资源服务的所有实例，计算所有服务的静态权重之和（totalWeight），使用0到totalWeight建立一个一位坐标系，将所有服务按照权重值分配到坐标系的每个节点&lt;/p&gt;
&lt;p&gt;例：目前有A、B、C三个服务，权重配置分别为A=10、B=20、C=10&lt;/p&gt;
&lt;p&gt;则A、B、C会分别位于距离坐标系原点10、30、40的位置，如下图&lt;/p&gt;
&lt;figure data-type=&#34;image&#34; tabindex=&#34;1&#34;&gt;&lt;img src=&#34;https://image.yhzdys.com/RKaAgU.png&#34; alt=&#34;&#34; loading=&#34;lazy&#34;&gt;&lt;/figure&gt;
&lt;p&gt;在所有服务的权重之和（totalWeight）范围内建立一个一位坐标系，以0为下限以totalWeight为上限取随机数，当随机数落点在服务各自的范围内时，则对应的服务作为选举结果&lt;/p&gt;
&lt;h2 id=&#34;实例演示&#34;&gt;实例演示&lt;/h2&gt;
&lt;p&gt;没有，自己脑补吧&lt;/p&gt;
">加权随机算法</a>
                </div>
            
                <div class="item">
                    <a class="result-title" style="opacity: 0;" href="https://blog.yhzdys.com/post/220304224140/"" data-c="
                    &lt;blockquote&gt;
&lt;p&gt;前几天参加某公司面试，被问到Dubbo的负载均衡算法实现，由于电话面试无法画图详解，不才小生简单口头描述后，换来面试官一句“没这么复杂吧”（...）。于是写下此篇文章，详细介绍下Dubbo框架中负载均衡的加权轮训算法实现。后续如果有闲情的话，再完善其余的算法实现（大概）&lt;/p&gt;
&lt;/blockquote&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;简单介绍&#34;&gt;简单介绍&lt;/h2&gt;
&lt;p&gt;负载均衡（LoadBalance）的详细定义请参考&lt;a href=&#34;https://en.wikipedia.org/wiki/Load_balancing_(computing)&#34;&gt;&lt;strong&gt;维基百科&lt;/strong&gt;&lt;/a&gt;以及&lt;a href=&#34;https://dubbo.apache.org/zh/docs/advanced/loadbalance/&#34;&gt;&lt;strong&gt;Dubbo官方文档&lt;/strong&gt;&lt;/a&gt;，简单来说就是针对服务集群，按照特定的规则对请求进行分发，使集群下的资源被平衡访问的一种技术。&lt;/p&gt;
&lt;h2 id=&#34;加权轮训算法&#34;&gt;加权轮训算法&lt;/h2&gt;
&lt;p&gt;负载均衡的一种算法实现，效果是按服务的权重设置轮询比率，循环请求资源服务。Dubbo 借鉴 Nginx 的平滑加权轮询算法，并对此做了优化。&lt;/p&gt;
&lt;h2 id=&#34;源码分析&#34;&gt;源码分析&lt;/h2&gt;
&lt;p&gt;Dubbo的负载均衡算法实现，放在org.apache.dubbo.rpc.cluster包下，以org.apache.dubbo.rpc.cluster.LoadBalance定义，通过SPI功能动态加载，默认实现为org.apache.dubbo.rpc.cluster.loadbalance.RandomLoadBalance（加权随机），本文着重介绍Dubbo框架下的另一种负载均衡实现-加权轮训，源码位置org.apache.dubbo.rpc.cluster.loadbalance.RoundRobinLoadBalance#doSelect&lt;/p&gt;
&lt;h3 id=&#34;源码实现&#34;&gt;源码实现&lt;/h3&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;protected &amp;lt;T&amp;gt; Invoker&amp;lt;T&amp;gt; doSelect(List&amp;lt;Invoker&amp;lt;T&amp;gt;&amp;gt; invokers, URL url, Invocation invocation) {
        String key = invokers.get(0).getUrl().getServiceKey() + &amp;quot;.&amp;quot; + invocation.getMethodName();
        ConcurrentMap&amp;lt;String, WeightedRoundRobin&amp;gt; map = methodWeightMap.computeIfAbsent(key, k -&amp;gt; new ConcurrentHashMap&amp;lt;&amp;gt;());
        // 所有服务的静态权重之和
        int totalWeight = 0;
        long maxCurrent = Long.MIN_VALUE;
        long now = System.currentTimeMillis();
        Invoker&amp;lt;T&amp;gt; selectedInvoker = null;
        WeightedRoundRobin selectedWRR = null;
        for (Invoker&amp;lt;T&amp;gt; invoker : invokers) {
            String identifyString = invoker.getUrl().toIdentityString();
            // 获取配置的静态权重
            int weight = getWeight(invoker, invocation);
            // 服务权重的二次包装
            WeightedRoundRobin weightedRoundRobin = map.computeIfAbsent(identifyString, k -&amp;gt; {
                WeightedRoundRobin wrr = new WeightedRoundRobin();
                wrr.setWeight(weight);
                return wrr;
            });

            if (weight != weightedRoundRobin.getWeight()) {
                weightedRoundRobin.setWeight(weight);
            }
            // 当前动态权重自增，自增值为服务的静态权重
            long cur = weightedRoundRobin.increaseCurrent();
            weightedRoundRobin.setLastUpdate(now);
            // 选出动态权重最大的那台服务
            if (cur &amp;gt; maxCurrent) {
                maxCurrent = cur;
                selectedInvoker = invoker;
                selectedWRR = weightedRoundRobin;
            }
            totalWeight += weight;
        }
        if (invokers.size() != map.size()) {
            map.entrySet().removeIf(item -&amp;gt; now - item.getValue().getLastUpdate() &amp;gt; RECYCLE_PERIOD);
        }
        if (selectedInvoker != null) {
            // 被选中服务的动态权重会减去所有服务的静态权重之和
            selectedWRR.sel(totalWeight);
            return selectedInvoker;
        }
        return invokers.get(0);
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;源码分析-2&#34;&gt;源码分析&lt;/h3&gt;
&lt;p&gt;首先算法会轮训所调用服务的所有实例，计算所有服务的静态权重之和（totalWeight），并对各服务的权重使用内部类WeightedRoundRobin进行的二次包装，源码如下&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;protected static class WeightedRoundRobin {
        // 服务配置的静态权重
        private int weight;
        // 动态权重
        private AtomicLong current = new AtomicLong(0);
        private long lastUpdate;

        public int getWeight() {
            return weight;
        }

        public void setWeight(int weight) {
            this.weight = weight;
            // 初始化动态权重为0
            current.set(0);
        }
        // 操作动态权重，自增静态权重
        public long increaseCurrent() {
            return current.addAndGet(weight);
        }
        // 操作动态权重，减法
        public void sel(int total) {
            current.addAndGet(-1 * total);
        }

        public long getLastUpdate() {
            return lastUpdate;
        }

        public void setLastUpdate(long lastUpdate) {
            this.lastUpdate = lastUpdate;
        }
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;可以发现在WeightedRoundRobin中为所有服务定义了一个动态的权重值，该值后续会在每次服务调用后改变。可以看到Dubbo在第一次调用服务时，除了服务本身配置的静态权重外，还会给所有服务初始化一个值为0的动态权重。在每次选举之前，将所有服务的动态权重加上自身的静态权重后，选举出动态权重最大的服务进行调用，选举完成后再将选中服务的动态权重减去所有服务的静态权重之和（totalWeight），然后以此为循环，实现服务的加权轮询选举。&lt;/p&gt;
&lt;h2 id=&#34;实例演示&#34;&gt;实例演示&lt;/h2&gt;
&lt;p&gt;假设目前我们有ABC三台服务，其配置的权重分别为A=2 B=1 C=1（这里为了方便演示，实际情况下权重值的配置往往为百位数，来提高精细度），那么在进入选举时，会分别为这三台服务初始化值为0的动态权重，后续流程看下表。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;轮训次数&lt;/th&gt;
&lt;th&gt;选举前动态权重（自增静态权重）&lt;/th&gt;
&lt;th&gt;选举结果&lt;/th&gt;
&lt;th&gt;选举后动态权重（减去静态权重之和）&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;A(2) B(1) C(1)&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;td&gt;A(-2) B(1) C(1)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;A(0) B(2) C(2)&lt;/td&gt;
&lt;td&gt;B&lt;/td&gt;
&lt;td&gt;A(0) B(-2) C(2)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;A(2) B(-1) C(3)&lt;/td&gt;
&lt;td&gt;C&lt;/td&gt;
&lt;td&gt;A(2) B(-1) C(-1)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;A(4) B(0) C(0)&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;td&gt;A(0) B(0) C(0)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;A(2) B(1) C(1)&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;td&gt;A(-2) B(1) C(1)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;6&lt;/td&gt;
&lt;td&gt;A(0) B(2) C(2)&lt;/td&gt;
&lt;td&gt;B&lt;/td&gt;
&lt;td&gt;A(0) B(-2) C(2)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;7&lt;/td&gt;
&lt;td&gt;A(2) B(-1) C(3)&lt;/td&gt;
&lt;td&gt;C&lt;/td&gt;
&lt;td&gt;A(2) B(-1) C(-1)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;8&lt;/td&gt;
&lt;td&gt;A(4) B(0) C(0)&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;td&gt;A(0) B(0) C(0)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;9&lt;/td&gt;
&lt;td&gt;A(2) B(1) C(1)&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;td&gt;A(-2) B(1) C(1)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;可以看到，选举结果以A、B、C、A为一组进行循环，符合以A=2 B=1 C=1为权重配置的期望。&lt;/p&gt;
">加权轮询算法</a>
                </div>
            
                <div class="item">
                    <a class="result-title" style="opacity: 0;" href="https://blog.yhzdys.com/post/211027212445/"" data-c="
                    &lt;blockquote&gt;
&lt;p&gt;SPI 全称为 Service Provider Interface，是一种服务发现机制。SPI 的本质是将接口实现类的全限定名配置在文件中，并由服务加载器读取配置文件，加载实现类。这样可以在运行时，动态为接口替换实现类。正因此特性，我们可以很容易的通过 SPI 机制为我们的程序提供拓展功能。SPI 机制在第三方框架中也有所应用，比如 Dubbo 就是通过 SPI 机制加载所有的组件。不过，Dubbo 并未使用 java 原生的 SPI 机制，而是对其进行了增强，使其能够更好的满足需求。在 Dubbo 中，SPI 是一个非常重要的模块。基于 SPI，我们可以很容易的对 Dubbo 进行拓展。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;!-- more --&gt;
&lt;h2 id=&#34;dubbo-spi介绍&#34;&gt;Dubbo SPI介绍&lt;/h2&gt;
&lt;p&gt;Dubbo SPI实现了自己的IOC和AOP机制，其中服务的实例被称为Extension（扩展），类似于Spring框架中bean的角色，是一个扩展实现类的实例。Dubbo框架中所有类的实例基本都是使用了SPI的方式获取。所以了解SPI的实现机制是学习Dubbo的重中之重。&lt;/p&gt;
&lt;h2 id=&#34;dubbo-spi示例&#34;&gt;Dubbo SPI示例&lt;/h2&gt;
&lt;p&gt;这里以apache dubbo 2.x版本为例，引入dubbo依赖&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-XML&#34;&gt;&amp;lt;dependency&amp;gt;
    &amp;lt;groupId&amp;gt;org.apache.dubbo&amp;lt;/groupId&amp;gt;
    &amp;lt;artifactId&amp;gt;dubbo&amp;lt;/artifactId&amp;gt;
    &amp;lt;version&amp;gt;2.7.15&amp;lt;/version&amp;gt;
&amp;lt;/dependency&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;编写扩展类的接口&lt;br&gt;
@SPI的value为默认实现，@Adpative则为自适应加载注解，在代码运行时根据传入的URL（必传）参数动态加载，这个后面会详细讲解&lt;/p&gt;
&lt;p&gt;注：URL.class为Dubbo自定义，全限名：org.apache.dubbo.common.URL&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;@SPI(&amp;quot;apple&amp;quot;)
public interface Fruit {

    void printName();

    @Adaptive(&amp;quot;name&amp;quot;)
    void printName(URL url);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;编写Fruit接口的实现类：Apple、Banana、Orange&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class Apple implements Fruit {
    private static final String _name = &amp;quot;Apple&amp;quot;;

    @Override
    public void printName() {
        System.out.println(_name);
    }

    @Override
    public void printName(URL url) {
        this.printName();
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class Banana implements Fruit {
    private static final String _name = &amp;quot;Banana&amp;quot;;

    @Override
    public void printName() {
        System.out.println(_name);
    }

    @Override
    public void printName(URL url) {
        this.printName();
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class Orange implements Fruit {
    private static final String _name = &amp;quot;Orange&amp;quot;;

    @Override
    public void printName() {
        System.out.println(_name);
    }

    @Override
    public void printName(URL url) {
        this.printName();
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;在resources添加目录：META-INF/dubbo&lt;/p&gt;
&lt;p&gt;新建文件（dubbo约定文件名必须与接口全限定名一致）：com.xx.xx.Fruit&lt;/p&gt;
&lt;p&gt;编辑文件内容并保存，建议以kv形式保存，如果像Orange的配置，则Dubbo默认会以类名“orange”作为实现类的名称：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-properties&#34;&gt;apple=com.xx.xx.Apple
banana=com.xx.xx.Banana
# orange=com.xx.xx.Orange
com.xx.xx.Orange
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;编写Main方法测试运行：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public static void main(String[] args) {
    ExtensionLoader&amp;lt;Fruit&amp;gt; FruitExtensionLoader = ExtensionLoader.getExtensionLoader(Fruit.class);

    // 默认扩展对象，由@SPI注解声明
    Fruit fruit1 = FruitExtensionLoader.getDefaultExtension();
    fruit1.printName();
    System.out.println(&amp;quot;==============================&amp;quot;);

    Fruit fruit2 = FruitExtensionLoader.getExtension(&amp;quot;banana&amp;quot;);
    fruit2.printName();
    System.out.println(&amp;quot;==============================&amp;quot;);

    Map&amp;lt;String, String&amp;gt; parameters = new HashMap&amp;lt;&amp;gt;(2);
    // key在@Adpative中指定，否则默认取类名，例：fruit
    parameters.put(&amp;quot;name&amp;quot;, &amp;quot;orange&amp;quot;);
    URL url = new URL(&amp;quot;&amp;quot;, &amp;quot;&amp;quot;, 0, parameters);

    Fruit fruit3 = FruitExtensionLoader.getAdaptiveExtension();
    fruit3.printName(url);
    System.out.println(&amp;quot;==============================&amp;quot;);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;执行结果：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;Apple
==============================
Banana
==============================
Orange
==============================
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;源码解析&#34;&gt;源码解析&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;为方便理解，源码会做相应的修改和省略&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;SPI核心入口ExtensionLoader.getExtensionLoader()&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;// ExtensionLoader示例缓存
private static final ConcurrentMap&amp;lt;Class&amp;lt;?&amp;gt;, ExtensionLoader&amp;lt;?&amp;gt;&amp;gt; EXTENSION_LOADERS = new ConcurrentHashMap&amp;lt;&amp;gt;();

******

public static &amp;lt;T&amp;gt; ExtensionLoader&amp;lt;T&amp;gt; getExtensionLoader(Class&amp;lt;T&amp;gt; type) {
    ******
    ExtensionLoader&amp;lt;T&amp;gt; loader = (ExtensionLoader&amp;lt;T&amp;gt;) EXTENSION_LOADERS.get(type);
    if (loader == null) {
        EXTENSION_LOADERS.putIfAbsent(type, new ExtensionLoader&amp;lt;T&amp;gt;(type));
        loader = (ExtensionLoader&amp;lt;T&amp;gt;) EXTENSION_LOADERS.get(type);
    }
    return loader;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;EXTENSION_LOADERS为ExtensionLoader实例的缓存缓存&lt;/p&gt;
&lt;p&gt;看ExtensionLoader构造函数，ExtensionFactory可以近似理解为Spring中的BeanFactory，作为获取Extension实例的工厂，且支持自适应扩展&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;private final ExtensionFactory objectFactory;

******

private ExtensionLoader(Class&amp;lt;?&amp;gt; type) {
    this.type = type;
    // ExtenFactory本身不需要
    if (type == ExtensionFactory.class) {
      objectFactory = null;
    } else {
      // 获取对象工厂
      objectFactory = ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension();
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;查看接口ExtensionFactory的实现类，这里先讲解Dubbo自己的SpiExtensionFactory&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class SpiExtensionFactory implements ExtensionFactory {

    @Override
    public &amp;lt;T&amp;gt; T getExtension(Class&amp;lt;T&amp;gt; type, String name) {
        if (type.isInterface() &amp;amp;&amp;amp; type.isAnnotationPresent(SPI.class)) {
            ExtensionLoader&amp;lt;T&amp;gt; loader = ExtensionLoader.getExtensionLoader(type);
            // 可加载的扩展类不为空，则加载
            if (!loader.getSupportedExtensions().isEmpty()) {
                return loader.getAdaptiveExtension();
            }
        }
        return null;
    }

}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;查看loader.getSupportedExtensions()&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public Set&amp;lt;String&amp;gt; getSupportedExtensions() {
    Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt; clazzes = getExtensionClasses();
    return Collections.unmodifiableSet(new TreeSet&amp;lt;&amp;gt;(clazzes.keySet()));
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;进入getExtensionClasses()，这里为一个double check lock实现的单例模式&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;private final Holder&amp;lt;Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt;&amp;gt; cachedClasses = new Holder&amp;lt;&amp;gt;();

******

private Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt; getExtensionClasses() {
    Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt; classes = cachedClasses.get();
    if (classes == null) {
        synchronized (cachedClasses) {
            classes = cachedClasses.get();
            if (classes == null) {
                classes = loadExtensionClasses();
                cachedClasses.set(classes);
            }
        }
    }
    return classes;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;进入loadExtensionClasses()，开始装载扩展类&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;private Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt; loadExtensionClasses() {
    cacheDefaultExtensionName();

    Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt; extensionClasses = new HashMap&amp;lt;&amp;gt;();

    for (LoadingStrategy strategy : strategies) {
        loadDirectory(extensionClasses, strategy.directory(), type.getName(), strategy.preferExtensionClassLoader(),
                strategy.overridden(), strategy.excludedPackages());
    }

    return extensionClasses;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;strategies使用jdk自带的ServiceLoader装载多种dubbo spi装载方式，本文主要看DubboLoadingStrategy，其中声明了配置文件读取路径为&amp;quot;META-INF/dubbo/&amp;quot;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class DubboLoadingStrategy implements LoadingStrategy {

    @Override
    public String directory() {
        return &amp;quot;META-INF/dubbo/&amp;quot;;
    }

}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;进入loadDirectory()，这里会根据LoadingStrategy配置的文件目录，解析并读取&lt;/p&gt;
&lt;p&gt;核心执行顺序为：loadDirectory() &amp;gt; loadResource() &amp;gt; loadClass()&lt;/p&gt;
&lt;p&gt;加载文件目录 &amp;gt; 加载spi配置文件 &amp;gt; 加载配置文件中的扩展实现类&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;private void loadDirectory(Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt; extensionClasses, String dir, String type,
                           boolean extensionLoaderClassLoaderFirst, boolean overridden, String... excludedPackages) {
    String fileName = dir + type;
    ******
    
    loadResource(extensionClasses, classLoader, resourceURL, overridden, excludedPackages);
    
    ******
}

private void loadResource(Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt; extensionClasses, ClassLoader classLoader,
                              java.net.URL resourceURL, boolean overridden, String... excludedPackages) {
    ******

    loadClass(extensionClasses, resourceURL, Class.forName(clazz, true, classLoader), name, overridden);

    ******
}

private void loadClass(Map&amp;lt;String, Class&amp;lt;?&amp;gt;&amp;gt; extensionClasses, java.net.URL resourceURL, Class&amp;lt;?&amp;gt; clazz, String name, boolean overridden) throws NoSuchMethodException {
        // @Adaptive注解放在类上，则表示类为默认的动态扩展实现
        if (clazz.isAnnotationPresent(Adaptive.class)) {
            // 缓存到Map
            cacheAdaptiveClass(clazz, overridden);
        } else
        // 构造函数参数唯一且为扩展接口类，则表示该类为包装类（Dubbo的AOP实现）
        if (isWrapperClass(clazz)) {
            // 缓存到Map
            cacheWrapperClass(clazz);
        } else {
            clazz.getConstructor();
            if (StringUtils.isEmpty(name)) {
                name = findAnnotationName(clazz);
            }
            // 扩展实现可以有多个名称，使用‘,‘分隔
            String[] names = NAME_SEPARATOR.split(name);
            if (ArrayUtils.isNotEmpty(names)) {
                cacheActivateClass(clazz, names[0]);
                for (String n : names) {
                    cacheName(clazz, n);
                    // 缓存到Map
                    saveInExtensionClass(extensionClasses, clazz, n, overridden);
                }
            }
        }
    }
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;到这，Dubbo SPI已经完成了对扩展接口实现类（注意是class，此时类还并未实例化）的扫描和缓存；&lt;/p&gt;
&lt;p&gt;接下来回头看ExtensionLoader#getDefaultExtension&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public T getDefaultExtension() {
    // 上文已说明，完成扩展类的扫描和缓存
    getExtensionClasses();
    // cachedDefaultName为@SPI声明
    if (StringUtils.isBlank(cachedDefaultName) || &amp;quot;true&amp;quot;.equals(cachedDefaultName)) {
        return null;
    }
    return getExtension(cachedDefaultName);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;进入getExtension，开始实例化扩展实现类，这里同样使用了double check lock保证单例&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public T getExtension(String name, boolean wrap) {
    if (&amp;quot;true&amp;quot;.equals(name)) {
        return getDefaultExtension();
    }
    final Holder&amp;lt;Object&amp;gt; holder = getOrCreateHolder(name);
    Object instance = holder.get();
    if (instance == null) {
        synchronized (holder) {
            instance = holder.get();
            if (instance == null) {
                instance = createExtension(name, wrap);
                holder.set(instance);
            }
        }
    }
    return (T) instance;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;进入createExtension，开始创建实例并出初始化实例&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;private static final ConcurrentMap&amp;lt;Class&amp;lt;?&amp;gt;, Object&amp;gt; EXTENSION_INSTANCES = new ConcurrentHashMap&amp;lt;&amp;gt;(64);

******

private T createExtension(String name, boolean wrap) {
        Class&amp;lt;?&amp;gt; clazz = getExtensionClasses().get(name);
        T instance = (T) EXTENSION_INSTANCES.get(clazz);
        // 缓存
        if (instance == null) {
            EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.getDeclaredConstructor().newInstance());
            instance = (T) EXTENSION_INSTANCES.get(clazz);
        }
        // 依赖注入
        injectExtension(instance);
        // 包装类（Dubbo AOP）
        if (wrap) {
            List&amp;lt;Class&amp;lt;?&amp;gt;&amp;gt; wrapperClassesList = new ArrayList&amp;lt;&amp;gt;();
            if (cachedWrapperClasses != null) {
                wrapperClassesList.addAll(cachedWrapperClasses);
                wrapperClassesList.sort(WrapperComparator.COMPARATOR);
                Collections.reverse(wrapperClassesList);
            }

            if (CollectionUtils.isNotEmpty(wrapperClassesList)) {
                for (Class&amp;lt;?&amp;gt; wrapperClass : wrapperClassesList) {
                    Wrapper wrapper = wrapperClass.getAnnotation(Wrapper.class);
                    if (wrapper == null
                            || (ArrayUtils.contains(wrapper.matches(), name) &amp;amp;&amp;amp; !ArrayUtils.contains(wrapper.mismatches(), name))) {
                        instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));
                    }
                }
            }
        }

        initExtension(instance);
        return instance;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;最后获取到扩展接口的默认实现类实例&lt;/p&gt;
&lt;p&gt;ExtensionLoader#getExtension()也是同理，这里将扩展实现类的名称已参数的形式传入，而不是读取@SPI的声明，这里不再赘述&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;接下来看getAdaptiveExtension方法，根据参数获取自适应实现类，这里仍然使用了单例模式&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;public T getAdaptiveExtension() {
    Object instance = cachedAdaptiveInstance.get();
    if (instance == null) {
        if (createAdaptiveInstanceError != null) {
            throw new IllegalStateException(&amp;quot;Failed to create adaptive instance: &amp;quot; +
                    createAdaptiveInstanceError.toString(),
                    createAdaptiveInstanceError);
        }

        synchronized (cachedAdaptiveInstance) {
            instance = cachedAdaptiveInstance.get();
            if (instance == null) {
                try {
                    instance = createAdaptiveExtension();
                    cachedAdaptiveInstance.set(instance);
                } catch (Throwable t) {
                    createAdaptiveInstanceError = t;
                    throw new IllegalStateException(&amp;quot;Failed to create adaptive instance: &amp;quot; + t.toString(), t);
                }
            }
        }
    }

    return (T) instance;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;进入createAdaptiveExtension&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;private T createAdaptiveExtension() {
    try {
        // 依赖注入
        return injectExtension(
          // 获取自适应类
          (T) getAdaptiveExtensionClass()
          // 实例化
          .newInstance()
        );
    } catch (Exception e) {
        throw new IllegalStateException(&amp;quot;Can&#39;t create adaptive extension &amp;quot; + type + &amp;quot;, cause: &amp;quot; + e.getMessage(), e);
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;进入getAdaptiveExtensionClass&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;private Class&amp;lt;?&amp;gt; getAdaptiveExtensionClass() {
    // 上文已说明，完成扩展类的扫描和缓存
    getExtensionClasses();
    if (cachedAdaptiveClass != null) {
        return cachedAdaptiveClass;
    }
    return cachedAdaptiveClass = createAdaptiveExtensionClass();
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;进入createAdaptiveExtensionClass，这里Dubbo为被@Adaptive声明的方法生成自适应实现，即自适应代理类&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;private Class&amp;lt;?&amp;gt; createAdaptiveExtensionClass() {
    String code = new AdaptiveClassCodeGenerator(type, cachedDefaultName).generate();
    ClassLoader classLoader = findClassLoader();
    // Dubbo默认使用javassist类编辑器，生成代理类
    org.apache.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(org.apache.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();
    return compiler.compile(code, classLoader);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;以上文Demo中的Fruit#printName(URL url)为例，Dubbo生成的代理类源码如下：&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class Fruit$Adaptive implements com.xx.xx.Fruit {
    public void printName() {
        throw new UnsupportedOperationException(&amp;quot;The method public abstract void com.xx.xx.Fruit.printName() of interface com.xx.xxFruit is not adaptive method!&amp;quot;);
    }

    public void printName(org.apache.dubbo.common.URL arg0) {
        if (arg0 == null) throw new IllegalArgumentException(&amp;quot;url == null&amp;quot;);
        org.apache.dubbo.common.URL url = arg0;
        // 根据url中的“name”参数动态获取扩展实例，默认为“apple”
        String extName = url.getParameter(&amp;quot;name&amp;quot;, &amp;quot;apple&amp;quot;);
        if (extName == null)
            throw new IllegalStateException(&amp;quot;Failed to get extension (com.xx.xx.Fruit) name from url (&amp;quot; + url.toString() + &amp;quot;) use keys([name])&amp;quot;);
        com.xx.xx.Fruit extension = (com.xx.xx.Fruit) ExtensionLoader.getExtensionLoader(com.xx.xx.Fruit.class).getExtension(extName);
        extension.printName(arg0);
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;到这里我们可以看到Dubbo的自适应扩展，其实现方式还是使用了ExtensionLoader.getExtensionLoader(Class).getExtension(name);&lt;/p&gt;
&lt;p&gt;参数name则是从URL中获取，key在@Adaptive注解中声明，value则在代码运行时动态输入，Dubbo则依靠这个机制实现动态自适应扩展类加载。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;本文只是简单介绍了Dubbo SPI的简单使用和主要实现原理，源码中还有诸多细节，无法全面覆盖，待后续补充 ......&lt;/p&gt;
">Dubbo SPI</a>
                </div>
            
                <div class="item">
                    <a class="result-title" style="opacity: 0;" href="https://blog.yhzdys.com/post/191003205847/"" data-c="
                    &lt;blockquote&gt;
&lt;p&gt;滑动时间窗算法通常被用于系统限流，限流的目的是通过对并发访问/请求进行限速，或者对一个时间段内的请求进行限速来保护系统，一旦达到限制速率程序可以进行拒绝、等待或降级等操作。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;!-- more --&gt;
&lt;p&gt;滑动时间窗算法是针对 &lt;em&gt;固定窗口算法&lt;/em&gt; 的改良，一定程度上缓解了固定窗口算法下的临界问题，它将单位时间周期分为n个小周期，分别记录每个小周期内接口的访问次数，并且根据时间滑动删除过期的小周期。&lt;/p&gt;
&lt;p&gt;当滑动时间窗的格子越小，那么窗口的滚动就越平滑，限流就会越精确。&lt;/p&gt;
&lt;h2 id=&#34;java实现&#34;&gt;Java实现&lt;/h2&gt;
&lt;p&gt;实场景中通常使用Redis的有序集合(sorted set)来实现&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public class SlideWindowLimiter {
    // 限流时间长度，单位：毫秒
    private final long windowTime;
    // 单个时间长度内限流次数
    private final int limitNum;
    private final List&amp;lt;Long&amp;gt; windows;

    public SlideWindowLimiter(long windowTime, int limitNum) {
        this.windowTime = windowTime;
        this.limitNum = limitNum;
        this.windows = new LinkedList&amp;lt;&amp;gt;();
    }

    public synchronized boolean outOfLimit() {
        // 获取当前时间
        long now = System.currentTimeMillis();
        // 如果队列还没满，则允许通过，并添加当前时间戳到队列开始位置
        if (this.windows.size() &amp;lt; this.limitNum) {
            this.windows.add(0, now);
            return true;
        }

        // 队列已满（达到限制次数），则获取队列中最早添加的时间戳
        int lastIndex = this.limitNum - 1;
        Long lastTime = this.windows.get(lastIndex);
        // 用当前时间戳 减去 最早添加的时间戳
        if (this.windowTime &amp;gt;= now - lastTime) {
            // 若结果小于等于timeWindow，则说明在timeWindow内，通过的次数大于limit
            // 不允许通过
            return false;
        } else {
            // 若结果大于时间窗长度，则说明在限定时间内，通过的次数小于等于limit
            // 允许通过，并删除最早添加的时间戳，将当前时间添加到队列开始位置
            this.windows.remove(lastIndex);
            this.windows.add(0, now);
            return true;
        }
    }

}
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;测试&#34;&gt;测试&lt;/h2&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;public static void main(String[] args) throws Exception {
        SlideWindowLimiter limiter = new SlideWindowLimiter(2 * 1000L, 3);
        System.out.println(limiter.outOfLimit());
        System.out.println(limiter.outOfLimit());
        Thread.sleep(990L);
        System.out.println(limiter.outOfLimit());
        System.out.println(limiter.outOfLimit());
        System.out.println(limiter.outOfLimit());
        Thread.sleep(990L);
        System.out.println(limiter.outOfLimit());
        System.out.println(limiter.outOfLimit());
        Thread.sleep(990L);
        System.out.println(limiter.outOfLimit());
        Thread.sleep(990L);
        System.out.println(limiter.outOfLimit());
        System.out.println(limiter.outOfLimit());
        System.out.println(limiter.outOfLimit());
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;结果&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;true
true
true
false
false
false
false
true
true
true
false
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;缺点&#34;&gt;缺点&lt;/h2&gt;
&lt;p&gt;滑动时间窗算法虽然解决了 &lt;em&gt;固定窗口算法&lt;/em&gt; 的临界问题，但是程序一旦到达限流次数后，程序的操作会被拒绝，会丢失相应的数据，所以这种算法一般用于对外的openAPI中，对于系统内部的业务实现，其实并不友好。&lt;/p&gt;
">滑动时间窗算法</a>
                </div>
            
                <div class="item">
                    <a class="result-title" style="opacity: 0;" href="https://blog.yhzdys.com/post/about/"" data-c="
                    &lt;p&gt;欢迎来到我的博客，很高兴遇见你！😄&lt;/p&gt;
&lt;h2 id=&#34;关于我&#34;&gt;关于我👌&lt;/h2&gt;
&lt;p&gt;17岁在读高中生，住在衣柜里。&lt;/p&gt;
&lt;h2 id=&#34;联系方式&#34;&gt;联系方式📝&lt;/h2&gt;
&lt;p&gt;e-mail: yhzdys@foxmail.com&lt;br&gt;
github: https://github.com/yhzdys&lt;/p&gt;
">关于本站</a>
                </div>
            
        </div>
        <div class="page">
            <div id="page_ul"></div>
        </div>
    </div>
</div>
<script>
    !function () {
        let searchMask = document.querySelector('#search_mask');
        let result = document.querySelector('#result');
        let items = document.querySelectorAll('.item');
        let searchBox = document.querySelector('#search');
        let statCount = document.querySelector('#stat_count');
        let statTimes = document.querySelector('#stat_times');
        let pageUl = document.querySelector('#page_ul');
        let close = document.querySelector('#close');

        close.addEventListener('click', function () {
            searchMask.style = 'display: none;'
        })

        let finds = [];
        let contents = [];
        let pageSize = 10;
        items.forEach(item => {
            let a = item.querySelector('a');
            contents.push({
                title: a.innerText,
                details: a.dataset.c,
                link: a.href
            })
            item.remove();
        })

        function insertStr(soure, start, count) {
            let newStr = soure.substr(start, count);
            return soure.slice(0, start) + '<em>' + newStr + '</em>' + soure.slice(start + count);
        }

        pageUl.addEventListener('click', function (event) {
            let target = event.target;
            if (target.__proto__ === HTMLSpanElement.prototype) {
                appendResults(parseInt(target.dataset.i));
            }
        })

        function appendResults(index) {
            let htmlResult = '';
            let start = index || 0;
            let end = Math.min(start + pageSize, finds.length);
            for (let i = start; i < end; i++) {
                const current = finds[i];
                let html = current.title;
                let sum = 0;
                let positions = current.positions;
                positions.forEach(position => {
                    html = insertStr(html, position.start + sum, position.count);
                    sum += 9;
                })
                htmlResult += `<div class="item"><a class="result-title" href="${current.link}">${html}</a></div>`;
            }
            result.innerHTML = htmlResult;
            pageUl.innerHTML = '';
            let count = finds.length / pageSize;
            let lis = '';
            if (start !== 0) {
                lis += `<span class="fa fa-angle-left" data-i='${start - 1}'></span>`;
            }
            for (let i = 0; i < count; i++) {
                lis += `<span class='${i === start ? 'current' : ''}' data-i='${i}'>${i + 1}</span>`;
            }
            if (start + 1 < count) {
                lis += `<span class="fa fa-angle-right" data-i='${start + 1}'></span>`;
            }
            pageUl.innerHTML = lis;
        }

        function search(delay) {
            let timer = null
            return function () {
                clearTimeout(timer)
                timer = setTimeout(() => {
                    let start = Date.now();
                    let segments = searchBox.value.split(' ').filter(c => c != '');
                    if (segments.length <= 0) {
                        return;
                    }
                    finds = [];
                    let htmlResult = '';
                    contents.forEach(content => {
                        let title = content.title;
                        let positions = [];
                        let find = false;
                        segments.forEach((segment) => {
                            if (content.title.includes(segment)) {
                                find = true;
                                positions.push({
                                    start: content.title.indexOf(segment),
                                    count: segment.length
                                })
                            } else if (content.details.includes(segment)) {
                                find = true;
                            }
                        });
                        if (find) {
                            finds.push({
                                title: content.title,
                                link: content.link,
                                positions
                            });
                        }
                    })
                    appendResults(0);
                    statCount.textContent = finds.length;
                    statTimes.textContent = Date.now() - start;
                }, delay)
            }
        }

        searchBox.addEventListener('input', search(200));
    }()
</script>

<input hidden id="copy"/>
<script>
    !function () {
        let times = document.querySelectorAll('.publish-time');
        for (let i = 0; i < times.length; i++) {
            let date = times[i].dataset.t;
            let time = Math.floor((new Date().getTime() - new Date(date).getTime()) / 1000);
            if (time < 60) {
                str = time + '秒之前';
            } else if (time < 3600) {
                str = Math.floor(time / 60) + '分钟之前';
            } else if (time >= 3600 && time < 86400) {
                str = Math.floor(time / 3600) + '小时之前';
            } else if (time >= 86400 && time < 259200) {
                str = Math.floor(time / 86400) + '天之前';
            } else {
                str = times[i].textContent;
            }
            times[i].textContent = str;
        }
    }();
</script>

<script>
    let language = '';
    if (language !== '') {
        let map = new Map();
        if (language === 'en') {
            map.set('search', 'Search');
            map.set('category', 'Categories');
            map.set('article', 'Articles');
            map.set('tag', 'Tags');
            map.set('top', 'Top');
            map.set('publish', 'published');
            map.set('minute', ' minutes');
            map.set('read-more', 'Read More');
            map.set('view', 'View');
            map.set('words', ' words');
            map.set('category-in', 'category in');
            map.set('preview', 'Meta');
            map.set('index', 'Toc');
            map.set('no-archives', "You haven't created yet");
            map.set('archives', " articles in total");
            map.set('cloud-tags', " tags in total");
            map.set('copyright', "Copyright: ");
            map.set('author', "Author: ");
            map.set('link', "Link: ");
            map.set('leave-message', "Leave a message");
            map.set('format', "Links Format");
            map.set('site-name', "Name: ");
            map.set('site-link', "Link: ");
            map.set('site-desc', "Desc: ");
            map.set('stat', " related results, taking ");
            map.set('stat-time', " ms");
            map.set('site-img', "Image: ");
        }

        if (map.size > 0) {
            let lanElems = document.querySelectorAll('.language');
            lanElems.forEach(elem => {
                let lan = elem.dataset.lan, text = map.get(lan);
                if (elem.__proto__ === HTMLInputElement.prototype) {
                    elem.placeholder = text
                } else {
                    if (elem.dataset.count) {
                        text = elem.dataset.count + text;
                    }
                    elem.textContent = text;
                }
            })
        }
    }

    window.Clipboard = (function (window, document, navigator) {
        var textArea,
            copy;

        function isOS() {
            return navigator.userAgent.match(/ipad|iphone/i);
        }

        function createTextArea(text) {
            textArea = document.createElement('textArea');
            textArea.value = text;
            textArea.style.width = 0;
            textArea.style.height = 0;
            textArea.clientHeight = 0;
            textArea.clientWidth = 0;
            document.body.appendChild(textArea);
        }

        function selectText() {
            var range,
                selection;

            if (isOS()) {
                range = document.createRange();
                range.selectNodeContents(textArea);
                selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                textArea.setSelectionRange(0, 999999);
            } else {
                textArea.select();
            }
        }

        function copyToClipboard() {
            try {
                document.execCommand("Copy")
            } catch (err) {
                alert("复制错误！请手动复制！")
            }
            document.body.removeChild(textArea);
        }

        copy = function (text) {
            createTextArea(text);
            selectText();
            copyToClipboard();
        };

        return {
            copy: copy
        };
    })(window, document, navigator);

    function copyCode(e) {
        if (e.srcElement.tagName === 'SPAN' && e.srcElement.classList.contains('copy-code')) {
            let code = e.currentTarget.querySelector('code');
            var text = code.innerText;
            if (e.srcElement.textContent === '复制成功') {
                return;
            }
            e.srcElement.textContent = '复制成功';
            (function (elem) {
                setTimeout(() => {
                    if (elem.textContent === '复制成功') {
                        elem.textContent = '复制代码'
                    }
                }, 1000);
            })(e.srcElement)
            Clipboard.copy(text);
        }
    }

    let pres = document.querySelectorAll('pre');
    pres.forEach(pre => {
        let code = pre.querySelector('code');
        let copyElem = document.createElement('span');
        copyElem.classList.add('copy-code');
        copyElem.textContent = '复制代码';
        pre.appendChild(copyElem);
        pre.onclick = copyCode
    })

</script>
<script src="/media/js/motion.js"></script>


    <script src="https://cdn.staticfile.org/smooth-scroll/16.1.3/smooth-scroll.polyfills.min.js"></script>
    <script>
        var scroll = new SmoothScroll('a[href*="#"]', {
            speed: 200
        });
    </script>







</html>